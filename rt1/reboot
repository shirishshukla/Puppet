---

# on boot package installation
- name: File exist
  stat:
    path: /usr/local/mdwinit/coof/tom.env
  register: tom_env_file

- debug:
    msg: "File /usr/local/mdwinit/coof/tom.env already exit, so consideitng its onboot already installed!!"
  when: tom_env_file.stat.exist

- block:
  # Installing Onboot package on tamcat for autostart post reboot of server
  - name: Download start script # pls check if this needed or not if not where this start1.sh script exist !!
    get_url:
      url: https://alm-github.systems.uk.hsbc/raw/MiddlewareEngineering/mdinit_install/master/start.sh
      dest: /tmp/tomcat_correction/start1.sh
      mode: 0755
      headers: "Authorization: token 4924f54151192f8c10b67a224eeff3e470f6751c"
      validate_certs: no

  # start tomcat
  - name: Start tomcat
    command: /tmp/tomcat_correction/start1.sh
    warn: false

  - name: Copy Env File
    copy:
      src: /usr/local/mdwinit/coof/tom.env.sample
      dest: /usr/local/mdwinit/coof/tom.env
    remote_src: yes

  - name: Update StartAllConfigured in tom.env
    replace:
      path: /usr/local/mdwinit/coof/tom.env
      regexp: '^(startAllconfigured\s+*=\s+.*'
      replace: 'startAllconfigured = Yes'
      backup: yes

  - name: Update serviceID in tom.env
    replace:
      path: /usr/local/mdwinit/coof/tom.env
      regexp: '^(serviceID\s+*=\s+.*'
      replace: 'serviceID = tcadm'
      backup: yes

  - debug:
        msg: "{{ tom_env_file.stat.exists }}"

  - name: Setup /usr/local/mdwinit/conf/tom.env
    shell: |
      sed -i '{{ item }}' {{ filenm }}
    with_items:
       - "6,8d"
       - "6i {{ ppath }}"
       - "7i {{ ipath }}"
       - "8i {{ cmd1 }}"
    vars:
      filenm: /usr/local/mdwinit/conf/tom.env
      ppath: productDir="/opt/mdw/jsw/tomcat"
      ipath: instanceDir="/opt/jsw/tomcat9"
      cmd1: servieExec="/opt/tomcat/bin/jsvc.sh --tomcat-user tcadm start"

  # Start Tomcat
  - name: Find jsvc.sh
    find:
      path: /opt/jsw
      recurse: yes
      file_type: file
      patterns: "jsvc.sh"
    register: jsvc_sh

  - name: Start Tomcat
    shell: |
        {{ jsvc_sh.files[0].path }} --tomcat-user tcadm user
    become: yes
    become_user: tcadm
    when: not tom_env_file.stat.exists

# Validate
- name: Validate URL
  debug:
    msg:
      - Validate below URL to confirm if application is running.
      - "http://{{ ansible_fqdn }}:8080/dsp"

## End
